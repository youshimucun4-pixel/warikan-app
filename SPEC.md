# 割り勘帳 — 要件・仕様書

## 1. 概要

**アプリ名:** 割り勘帳  
**用途:** 2人間の割り勘・建て替え・家計管理  
**プラットフォーム:** PWA（Progressive Web App）— iPhone Safari / Android Chrome / PC ブラウザ対応  
**ホスティング:** GitHub Pages  
**バックエンド:** Firebase Authentication（ユーザー認証） / Firebase Firestore（リアルタイム同期） / localStorage（オフライン）

**認証:** 利用開始時にアカウント登録・ログインが必須。Googleログインまたはメール・パスワードで登録・ログインする。

---

## 2. 対象ユーザー・ユースケース

| ユースケース | 説明 |
|---|---|
| カップル家計簿 | 同棲カップルが月々の共同支出を記録・清算 |
| 旅行の建て替え | 旅行中の支出を記録し、後で精算 |
| ルームシェア | 共同生活での光熱費・日用品等の割り勘 |

---

## 3. 機能要件

### 3.0 認証（アカウント）

| 項目 | 仕様 |
|---|---|
| 起動時 | 未ログイン時は「最初の画面」を表示。ログイン・登録後にホーム画面へ遷移。 |
| サインイン方法 | **Google**（推奨） / **メール・パスワード**（新規登録・ログイン） |
| 最初の画面 | 「Googleで続ける」「メールで登録」「すでにアカウントがある方はログイン」 |
| 設定内アカウント | 未ログイン時: Googleでログイン / メールで新規登録 / メールでログイン。ログイン時: 表示名・メール表示、ログアウト |
| 技術 | Firebase Authentication（signInWithPopup for Google / createUserWithEmailAndPassword / signInWithEmailAndPassword） |
| 認証済みドメイン | 本番利用時は Firebase Console の Authentication → Authorized domains に GitHub Pages ドメインを追加すること |

- ログイン済みユーザーが再度アプリを開いた場合は、認証状態が復元されそのままホーム画面を表示する。
- Firebase が利用できない環境では認証をスキップし、従来どおりホーム画面から利用可能（フォールバック）。

### 3.1 グループ管理

| 項目 | 仕様 |
|---|---|
| グループ上限 | **アクティブ最大3つ**（アーカイブは上限外） |
| グループ名 | 最大20文字、自由に設定・変更可能 |
| モード | **個人モード**（ソロ家計簿）/ **ふたりモード**（割り勘・建て替え）/ **グループモード**（3〜10人の飲み会・旅行） |
| メンバー | 個人モード: 1人 / ふたりモード: 2人固定（各参加者が参加時に自分の名前を入力） / グループモード: 3〜10人 |
| 未ログイン制限 | アクティブグループ **1つまで**。ログイン後は最大3つ |
| 作成方法 | Firebase同期モード / ローカルモード |
| 共有方法 | 6文字の英数字「合言葉」コードで相手を招待 |
| 操作 | 名前変更 / アーカイブ / アーカイブ解除 / 削除 |
| ホーム画面 | グループ一覧をカード形式で表示 |

#### グループのライフサイクル

```
作成 → アクティブ → アーカイブ → 削除
                   → 削除
```

- **アーカイブ:** 一覧の「アーカイブ」セクションに移動。データは保持。アクティブ上限から除外。
- **削除:** ローカルデータ完全削除。Firebase上のデータはサーバーに残る。
- **アーカイブ解除:** アクティブグループが3未満の場合のみ可能。
- **ふたり + Firebase の名前入力:** 作成者は「あなたの名前」のみ入力して部屋作成。参加者は合言葉入力時に「あなたの名前」を入力し、未設定側メンバー名として登録される。

### 3.2 支出記録

| 項目 | 仕様 |
|---|---|
| カテゴリ | 旅行 ✈️ / 外食 🍽️ / 家賃 🏠 / 日用品 🧴 / 食材 🥬 / 光熱費 ⚡ / その他 📦 |
| 内容 | テキスト入力（必須） |
| 金額 | 数値入力（1以上、必須） |
| 日付 | 日付ピッカー（必須） |
| 支払者 | ペア: ひとりめ or ふたりめ（ラジオ） / グループ: メンバーから選択（ラジオグリッド） |
| 負担割合 | ペア: 半々(50:50) / カスタム(任意%) / 全額片方(100:0) |
| グループ負担 | 全員で均等 / 選んで均等（メンバー選択） / 金額指定（各メンバー円額） |
| 操作 | 追加 / 編集 / 削除 |

### 3.3 月別表示

- 月ナビゲーション（前月/次月）で月を切り替え
- 表示内容:
  - 合計支出額
  - 各人の支払い済み金額
  - 清算額（誰が誰にいくら払うか）
  - カテゴリ別割合バー
  - 支出一覧（日付降順）

### 3.4 分析機能

#### ドーナツチャート（カテゴリ別支出）
- 選択月のカテゴリ別割合を円グラフ（SVGドーナツ）で表示
- 中央に合計金額
- 凡例: カテゴリ名、割合（%）、金額

#### 月別推移チャート（棒グラフ）
- 過去6ヶ月分の支出推移をスタック型棒グラフで表示
- カテゴリフィルタ: 「すべて」または特定カテゴリで絞り込み可能
- 当月は赤色ラベルで強調

### 3.5 データ同期

| モード | 説明 |
|---|---|
| Firebase同期 | Firestore `onSnapshot` によるリアルタイム同期。オフラインキャッシュ対応。 |
| ローカルモード | Firebase未設定時に自動フォールバック。localStorage のみ使用。 |

#### Firebase 構造

```
rooms/
  {roomCode}/
    // ペアモード
    users: { user1: string, user2: string }  // user2 は参加前は空文字になりうる
    createdAt: Timestamp

    // グループモード（mode='group' のとき）
    mode: 'group'
    members: [{ id: string, name: string }, ...]  // 3-10人
    memberUids: [uid, ...]

    expenses/
      {expenseId}/
        category: string
        description: string
        amount: number
        date: string (YYYY-MM-DD)

        // ペアモード
        paidBy: "user1" | "user2"
        splitUser1: number (0-100)
        splitUser2: number (0-100)

        // グループモード
        paidBy: memberId (例: "m1")
        splits: { memberId: number(円), ... }  // 各メンバーの負担額
```

### 3.6 清算機能

- 清算金額が発生している場合、「LINEで送る」ボタンを表示
- LINE共有: LINE URLスキーム (`https://line.me/R/share`) を使用して清算情報をテキスト共有
- 清算テキスト例: `2026年2月の清算\nたけし → まい: ¥3,500\n合計: ¥15,000`

#### グループモード清算アルゴリズム
- N人の最少送金数をGreedy方式で計算（最大N-1回の送金）
- 各メンバーのbalance = 支払い済み額 - 負担額 を算出
- balance > 0 → 債権者（受け取り）、balance < 0 → 債務者（支払い）
- 最大債務者と最大債権者をマッチングし、min(debt, credit)を送金
- 結果例: `太郎 → 花子: ¥2,000 / 次郎 → 花子: ¥1,500`

### 3.7 設定

- **アカウント:** ログイン状態の表示、Googleでログイン / メールで新規登録・ログイン、ログアウト
- グループ名の変更
- メンバー名の変更（Firebase時はサーバーに反映）
- 合言葉コードの表示・コピー（Firebase時のみ）
- データエクスポート（JSON）
- グループからの退出

---

## 4. 非機能要件

### 4.1 PWA対応

| 項目 | 対応 |
|---|---|
| Service Worker | キャッシュ優先 + バックグラウンド更新 |
| manifest.json | スタンドアロン表示、ポートレート固定 |
| iOS対応 | apple-touch-icon, safe-area-inset, apple-mobile-web-app-capable |
| オフライン | Firestoreオフラインキャッシュ + Service Workerキャッシュ |

### 4.2 デザイン

- **テーマ:** 和のインク＆紙（Warm Ink & Paper）
- **カラーパレット:** クリーム背景 (#F5F0E8)、墨色テキスト (#2C2416)、テラコッタアクセント (#C65D3E)
- **フォント:** Shippori Mincho B1（見出し）、Zen Kaku Gothic New（本文）
- **アニメーション:** フェード+スライドアップの段階的表示
- **レスポンシブ:**
  - モバイル: シングルカラム（最大幅480px）
  - タブレット (768px+): 記録パネルで2カラムグリッド（支出一覧 | サマリー+カテゴリ）、ホームのグループカード2列
  - デスクトップ (1024px+): ホームのグループカード3列、オンボーディングステップ横並び
- **iOS Safe Area:** 対応済み

### 4.3 パフォーマンス

- 外部ライブラリ最小限（Firebase SDKのみ）
- チャートは純CSS/SVGで描画（ライブラリ不使用）
- Service Workerによるアセットキャッシュ

---

## 5. データモデル（ローカル）

### グループ一覧 (`warikan-groups`)

```json
[
  {
    "code": "ABC123",
    "name": "家計簿",
    "archived": false,
    "isLocal": false,
    "members": "たけし & まい"
  }
]
```

### ローカルグループデータ (`warikan-local-{code}`)

```json
{
  "users": { "user1": "たけし", "user2": "まい" },
  "expenses": [
    {
      "id": "abc123",
      "category": "grocery",
      "description": "スーパーで買い物",
      "amount": 3500,
      "date": "2026-02-10",
      "paidBy": "user1",
      "splitUser1": 50,
      "splitUser2": 50
    }
  ]
}
```

---

## 6. 画面遷移

```
[最初の画面]（未ログイン時のみ表示）
  ├─ Googleで続ける → ポップアップでGoogleログイン → [ホーム画面]
  ├─ メールで登録 → [認証モーダル] 新規登録 → [ホーム画面]
  └─ すでにアカウントがある方はログイン → [認証モーダル] ログイン → [ホーム画面]

[ホーム画面]（ログイン済み、または Firebase 未使用時）
  ├─ グループカード タップ → [メイン画面]
  │                           ├─ 記録タブ（デフォルト）
  │                           │   ├─ サマリー
  │                           │   ├─ カテゴリバー
  │                           │   └─ 支出一覧
  │                           ├─ 分析タブ
  │                           │   ├─ ドーナツチャート
  │                           │   └─ 月別推移棒グラフ
  │                           ├─ 設定（モーダル）※アカウント表示・ログアウト含む
  │                           └─ ← 戻る → [ホーム画面]
  ├─ ⋮ ボタン → [グループ操作モーダル]
  │               ├─ 名前を変更 → [リネームモーダル]
  │               ├─ アーカイブ / アーカイブ解除
  │               └─ 削除 → [確認ダイアログ]
  └─ ＋ 新しいグループ → [セットアップ画面]
                           ├─ モード選択: 個人で使う / ふたりで使う / グループで使う
                           ├─ 個人 → ソログループ作成（名前1つ）
                           ├─ ふたり + Firebase → 選択 → 作成(作成者名を入力) or 参加(参加者名を入力)
                           ├─ ふたり + ローカル → 直接作成
                           ├─ グループ + Firebase → 選択 → 作成(3-10人) or 参加
                           └─ グループ + ローカル → 直接作成(3-10人)
```

### 起動時の表示

- **Firebase 利用時・未ログイン:** 最初の画面（アカウント登録・ログイン）を表示。ログイン後にホーム画面へ。
- **Firebase 利用時・ログイン済み:** 認証状態を復元し、ホーム画面を表示。
- **Firebase 未使用時:** 従来どおりホーム画面を表示。
- ホーム画面での表示:
  - グループが0件 → オンボーディング（はじめましょう）＋ セットアップ誘導
  - グループが1件以上 → グループ一覧

---

## 7. 技術スタック

| レイヤー | 技術 |
|---|---|
| フロントエンド | HTML / CSS / Vanilla JavaScript |
| 認証 | Firebase Authentication（Google / メール・パスワード） |
| ストレージ | localStorage（ローカル）/ Firebase Firestore（同期） |
| ホスティング | GitHub Pages + GitHub Actions |
| PWA | Service Worker + manifest.json |
| フォント | Google Fonts (Shippori Mincho B1, Zen Kaku Gothic New) |
| Firebase SDK | v10.14.0 (compat): firebase-app, firebase-auth, firebase-firestore |

---

## 8. ファイル構成

```
warikan-app/
├── index.html          # メインHTML（最初の画面・ホーム・メイン・セットアップ・認証モーダル・設定等）
├── app.js              # アプリケーションロジック（認証・グループ・支出・分析・設定）
├── style.css           # スタイルシート
├── sw.js               # Service Worker
├── manifest.json       # PWAマニフェスト
├── icon.svg            # アプリアイコン（SVG）
├── SPEC.md             # 本仕様書
└── .github/
    └── workflows/
        └── deploy.yml  # GitHub Pages デプロイワークフロー
```

---

## 9. 制約事項

- グループメンバーは個人モード（1人）、ふたりモード（2人固定）、またはグループモード（3〜10人）
- ふたりモード（Firebase）のメンバー名は、作成者・参加者がそれぞれ参加時に自分で入力する
- アクティブグループ上限は3つ（Firebase無料枠の容量内で十分運用可能）
- **ユーザー認証:** Firebase 利用時はアカウント登録・ログインが必須（Google または メール・パスワード）。グループ間の共有は従来どおり合言葉（ルームコード）ベース。
- 本番ドメインで Google ログインを使う場合は、Firebase Console の Authentication → Authorized domains に該当ドメインを追加すること。
- Firebase Firestoreのテストモードルール使用中（本番運用時はセキュリティルール設定推奨）

---

## 10. 今後の拡張候補

### LINEリンク招待（優先度: 高）

合言葉コードの手動入力をなくし、LINEでURLを送るだけでグループに参加できる仕組み。

**フロー:**
1. グループ作成後、「LINEで招待」ボタンをタップ
2. アプリのURL + ルームコードをクエリパラメータに含むリンクを生成
   例: `https://youshimucun4-pixel.github.io/warikan-app/?join=ABC123`
3. LINE共有画面が開き、相手にリンクを送信
4. 相手がリンクをタップ → アプリが開く（PWAインストール済みならアプリ、未インストールならブラウザ）
5. URLのクエリパラメータからルームコードを自動取得し、グループ参加フローに入る

**技術的な検討事項:**
- `URLSearchParams` で `?join=CODE` を読み取り、起動時に自動で参加フローを開始
- 未ログインユーザーの場合: 先にログイン → ログイン後に参加処理を継続
- PWA Deep Link: `manifest.json` の `start_url` との整合性。クエリパラメータは Service Worker で適切に処理
- Universal Links / App Links: 将来的にネイティブアプリ化した場合の対応

### その他

- 認証ユーザーと Firestore ルームの紐付け（「自分のグループ」のクラウド保存）
- 3〜4人グループのN人清算対応（Greedy Algorithm）
- 月次レポートの自動生成・共有
- 定期的な支出テンプレート（家賃等の自動入力）
- プッシュ通知（清算リマインダー）
- グループ間の支出コピー
- ダークモード
- App Store / Google Play への公開（Capacitor等でラップ）
- Adaptive Icon（Android）の対応
