# 割り勘帳 — 要件・仕様書

## 1. 概要

**アプリ名:** 割り勘帳  
**用途:** 2人間の割り勘・建て替え・家計管理  
**プラットフォーム:** PWA（Progressive Web App）— iPhone Safari / Android Chrome / PC ブラウザ対応  
**ホスティング:** GitHub Pages  
**バックエンド:** Firebase Firestore（リアルタイム同期） / localStorage（オフライン）

---

## 2. 対象ユーザー・ユースケース

| ユースケース | 説明 |
|---|---|
| カップル家計簿 | 同棲カップルが月々の共同支出を記録・清算 |
| 旅行の建て替え | 旅行中の支出を記録し、後で精算 |
| ルームシェア | 共同生活での光熱費・日用品等の割り勘 |

---

## 3. 機能要件

### 3.1 グループ管理

| 項目 | 仕様 |
|---|---|
| グループ上限 | **アクティブ最大3つ**（アーカイブは上限外） |
| グループ名 | 最大20文字、自由に設定・変更可能 |
| メンバー | 2人固定（ひとりめ・ふたりめ） |
| 作成方法 | Firebase同期モード / ローカルモード |
| 共有方法 | 6文字の英数字「合言葉」コードで相手を招待 |
| 操作 | 名前変更 / アーカイブ / アーカイブ解除 / 削除 |
| ホーム画面 | グループ一覧をカード形式で表示 |

#### グループのライフサイクル

```
作成 → アクティブ → アーカイブ → 削除
                   → 削除
```

- **アーカイブ:** 一覧の「アーカイブ」セクションに移動。データは保持。アクティブ上限から除外。
- **削除:** ローカルデータ完全削除。Firebase上のデータはサーバーに残る。
- **アーカイブ解除:** アクティブグループが3未満の場合のみ可能。

### 3.2 支出記録

| 項目 | 仕様 |
|---|---|
| カテゴリ | 旅行 ✈️ / 外食 🍽️ / 家賃 🏠 / 日用品 🧴 / 食材 🥬 / 光熱費 ⚡ / その他 📦 |
| 内容 | テキスト入力（必須） |
| 金額 | 数値入力（1以上、必須） |
| 日付 | 日付ピッカー（必須） |
| 支払者 | ひとりめ or ふたりめ（ラジオボタン） |
| 負担割合 | 半々(50:50) / カスタム(任意%) / 全額片方(100:0) |
| 操作 | 追加 / 編集 / 削除 |

### 3.3 月別表示

- 月ナビゲーション（前月/次月）で月を切り替え
- 表示内容:
  - 合計支出額
  - 各人の支払い済み金額
  - 清算額（誰が誰にいくら払うか）
  - カテゴリ別割合バー
  - 支出一覧（日付降順）

### 3.4 分析機能

#### ドーナツチャート（カテゴリ別支出）
- 選択月のカテゴリ別割合を円グラフ（SVGドーナツ）で表示
- 中央に合計金額
- 凡例: カテゴリ名、割合（%）、金額

#### 月別推移チャート（棒グラフ）
- 過去6ヶ月分の支出推移をスタック型棒グラフで表示
- カテゴリフィルタ: 「すべて」または特定カテゴリで絞り込み可能
- 当月は赤色ラベルで強調

### 3.5 データ同期

| モード | 説明 |
|---|---|
| Firebase同期 | Firestore `onSnapshot` によるリアルタイム同期。オフラインキャッシュ対応。 |
| ローカルモード | Firebase未設定時に自動フォールバック。localStorage のみ使用。 |

#### Firebase 構造

```
rooms/
  {roomCode}/
    users: { user1: string, user2: string }
    createdAt: Timestamp
    expenses/
      {expenseId}/
        category: string
        description: string
        amount: number
        date: string (YYYY-MM-DD)
        paidBy: "user1" | "user2"
        splitUser1: number (0-100)
        splitUser2: number (0-100)
```

### 3.6 設定

- グループ名の変更
- メンバー名の変更（Firebase時はサーバーに反映）
- 合言葉コードの表示・コピー（Firebase時のみ）
- データエクスポート（JSON）
- グループからの退出

---

## 4. 非機能要件

### 4.1 PWA対応

| 項目 | 対応 |
|---|---|
| Service Worker | キャッシュ優先 + バックグラウンド更新 |
| manifest.json | スタンドアロン表示、ポートレート固定 |
| iOS対応 | apple-touch-icon, safe-area-inset, apple-mobile-web-app-capable |
| オフライン | Firestoreオフラインキャッシュ + Service Workerキャッシュ |

### 4.2 デザイン

- **テーマ:** 和のインク＆紙（Warm Ink & Paper）
- **カラーパレット:** クリーム背景 (#F5F0E8)、墨色テキスト (#2C2416)、テラコッタアクセント (#C65D3E)
- **フォント:** Shippori Mincho B1（見出し）、Zen Kaku Gothic New（本文）
- **アニメーション:** フェード+スライドアップの段階的表示
- **レスポンシブ:** モバイルファースト、最大幅480px
- **iOS Safe Area:** 対応済み

### 4.3 パフォーマンス

- 外部ライブラリ最小限（Firebase SDKのみ）
- チャートは純CSS/SVGで描画（ライブラリ不使用）
- Service Workerによるアセットキャッシュ

---

## 5. データモデル（ローカル）

### グループ一覧 (`warikan-groups`)

```json
[
  {
    "code": "ABC123",
    "name": "家計簿",
    "archived": false,
    "isLocal": false,
    "members": "たけし & まい"
  }
]
```

### ローカルグループデータ (`warikan-local-{code}`)

```json
{
  "users": { "user1": "たけし", "user2": "まい" },
  "expenses": [
    {
      "id": "abc123",
      "category": "grocery",
      "description": "スーパーで買い物",
      "amount": 3500,
      "date": "2026-02-10",
      "paidBy": "user1",
      "splitUser1": 50,
      "splitUser2": 50
    }
  ]
}
```

---

## 6. 画面遷移

```
[ホーム画面]
  ├─ グループカード タップ → [メイン画面]
  │                           ├─ 記録タブ（デフォルト）
  │                           │   ├─ サマリー
  │                           │   ├─ カテゴリバー
  │                           │   └─ 支出一覧
  │                           ├─ 分析タブ
  │                           │   ├─ ドーナツチャート
  │                           │   └─ 月別推移棒グラフ
  │                           ├─ 設定（モーダル）
  │                           └─ ← 戻る → [ホーム画面]
  ├─ ⋮ ボタン → [グループ操作モーダル]
  │               ├─ 名前を変更 → [リネームモーダル]
  │               ├─ アーカイブ / アーカイブ解除
  │               └─ 削除 → [確認ダイアログ]
  └─ ＋ 新しいグループ → [セットアップ画面]
                           ├─ Firebase: 選択 → 作成 or 参加
                           └─ ローカル: 直接作成
```

### 初回起動時

- グループが0件 → セットアップ画面を直接表示
- グループが1件 → そのグループに自動入室
- グループが2件以上 → ホーム画面を表示

---

## 7. 技術スタック

| レイヤー | 技術 |
|---|---|
| フロントエンド | HTML / CSS / Vanilla JavaScript |
| ストレージ | localStorage（ローカル）/ Firebase Firestore（同期） |
| ホスティング | GitHub Pages + GitHub Actions |
| PWA | Service Worker + manifest.json |
| フォント | Google Fonts (Shippori Mincho B1, Zen Kaku Gothic New) |
| Firebase SDK | v10.14.0 (compat) |

---

## 8. ファイル構成

```
warikan-app/
├── index.html          # メインHTML（全画面・モーダル含む）
├── app.js              # アプリケーションロジック
├── style.css           # スタイルシート
├── sw.js               # Service Worker
├── manifest.json       # PWAマニフェスト
├── icon.svg            # アプリアイコン（SVG）
├── SPEC.md             # 本仕様書
└── .github/
    └── workflows/
        └── deploy.yml  # GitHub Pages デプロイワークフロー
```

---

## 9. 制約事項

- グループメンバーは2人固定（3人以上は非対応）
- アクティブグループ上限は3つ（Firebase無料枠の容量内で十分運用可能）
- ユーザー認証なし（合言葉ベースのペアリング）
- Firebase Firestoreのテストモードルール使用中（本番運用時はセキュリティルール設定推奨）

---

## 10. 今後の拡張候補

- 3人以上のグループ対応
- 月次レポートの自動生成・共有
- 定期的な支出テンプレート（家賃等の自動入力）
- プッシュ通知（清算リマインダー）
- グループ間の支出コピー
- ダークモード
- App Store / Google Play への公開（Capacitor等でラップ）
