rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ルームドキュメント
    match /rooms/{roomCode} {

      // 読み取り: 認証済みユーザーのみ（参加時の存在確認にも必要）
      allow read: if request.auth != null;

      // 作成: 認証済み + memberUids に自分が含まれる + 必須フィールド検証
      allow create: if request.auth != null
        && request.auth.uid in request.resource.data.memberUids
        && request.resource.data.memberUids is list
        && (
          // ペアモード（既存）
          (request.resource.data.users is map
           && request.resource.data.users.user1 is string
           && request.resource.data.users.user2 is string)
          ||
          // グループモード（新規: 1-10人）
          (request.resource.data.mode == 'group'
           && request.resource.data.members is list
           && request.resource.data.members.size() >= 1
           && request.resource.data.members.size() <= 10)
        );

      // 更新: 認証済み + 既存メンバーのみ
      allow update: if request.auth != null
        && request.auth.uid in resource.data.memberUids;

      // 削除: 不許可（アプリ側はローカル削除のみ）
      allow delete: if false;

      // 支出サブコレクション
      match /expenses/{expenseId} {

        // 読み書き: 認証済み + 親ルームのメンバーのみ
        allow read, write: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/rooms/$(roomCode)).data.memberUids;
      }
    }

    // 10分有効の招待リンク
    match /invites/{inviteToken} {

      // 認証済みユーザーのみ。期限切れのリンクは読み取り不可
      allow read: if request.auth != null
        && request.time < resource.data.expiresAt;

      // 作成: 認証済み、作成者本人、11分以内の有効期限
      allow create: if request.auth != null
        && request.resource.data.roomCode is string
        && request.resource.data.createdByUid == request.auth.uid
        && request.resource.data.expiresAt is timestamp
        && request.resource.data.expiresAt > request.time
        && request.resource.data.expiresAt < request.time + duration.value(11, 'm');

      allow update, delete: if false;
    }

    // その他のコレクションはすべて拒否
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
