rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ルームドキュメント
    match /rooms/{roomCode} {

      // 読み取り: 認証済みユーザーのみ（参加時の存在確認にも必要）
      allow read: if request.auth != null;

      // 作成: 認証済み + memberUids に自分が含まれる + 必須フィールド検証
      allow create: if request.auth != null
        && request.auth.uid in request.resource.data.memberUids
        && request.resource.data.users is map
        && request.resource.data.users.user1 is string
        && request.resource.data.users.user2 is string
        && request.resource.data.memberUids is list;

      // 更新: 認証済み + 既存メンバーのみ
      allow update: if request.auth != null
        && request.auth.uid in resource.data.memberUids;

      // 削除: 不許可（アプリ側はローカル削除のみ）
      allow delete: if false;

      // 支出サブコレクション
      match /expenses/{expenseId} {

        // 読み書き: 認証済み + 親ルームのメンバーのみ
        allow read, write: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/rooms/$(roomCode)).data.memberUids;
      }
    }

    // その他のコレクションはすべて拒否
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
